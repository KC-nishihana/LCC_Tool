# Blender用 LCCツール

LCCツールは、LCC（Lightweight Compressed Cloud）スプラットデータをインポートしてレンダリングするために設計されたBlenderアドオンです。`.lcc`ファイルを読み込み、ジオメトリノードを使用して可視化し、Cyclesエンジンを使用して高品質な360度パノラマレンダリングをセットアップすることができます。

## 機能

*   **LCCインポート**: `.lcc`ファイルとそれに関連する `Index.bin` および `Data.bin` データを読み込みます。
*   **マルチLODサポート**: 指定した範囲（Min/Max）のLODデータをまとめて読み込み、統合して扱います。
*   **距離ベースのLOD制御**: カメラからの距離に応じて、遠くの点を間引くLODロジックをジオメトリノードで自動構築します。
*   **ビューポート最適化**: 編集時のパフォーマンスを確保するため、3Dビューポート上では点群の約10%のみをランダムに表示します（レンダリング時は100%表示されます）。
*   **ジオメトリノードレンダリング**: スプラットを3D形状（Cubeベース）としてレンダリングするためのモディファイアをセットアップします。
*   **カスタムシェーダー**: ガウス減衰（Gaussian falloff）を持つ `GaussianSplatMat` マテリアルを生成し、正確なスプラット表現を行います。
*   **360度レンダリングセットアップ**: パノラマカメラを自動構成し、Cyclesの透過設定を最適化します。
*   **🆕 3DGS (3D Gaussian Splatting) 表現機能**: 高度な3Dガウススプラッティング技術を実装し、高品質なビューポート表示とレンダリングを実現します。
    *   **GLSLレンダラー**: OpenGL を使用した高性能なビューポートレンダリング
    *   **EWA (Elliptical Weighted Average) スプラッティング**: 楕円加重平均法による正確な投影
    *   **共分散行列処理**: 3D から 2D への適応的な投影のための共分散行列計算
    *   **インスタンシング最適化**: GPU による効率的な大量スプラット描画
    *   **テクスチャベースのデータ管理**: GPU テクスチャを活用した高速データアクセス
    *   **クォータニオン回転**: 正確な 3D 回転表現とスムーズな補間

## 必須要件

*   **Blender**: バージョン 3.3 以上（ジオメトリノードの互換性のため推奨）。
*   **Python ライブラリ**: `numpy`（Blenderに標準搭載されています）。

## インストール方法

1.  `LCC_Render.py` をダウンロードします。
2.  Blenderを開きます。
3.  **編集 (Edit) > プリファレンス (Preferences) > アドオン (Add-ons)** に移動します。
4.  **インストール... (Install...)** をクリックし、`LCC_Render.py` を選択します。
5.  **Import-Export: LCC Tools** のチェックボックスをオンにして、アドオンを有効にします。

## 使用方法

1.  3Dビューポートで `N` キーを押してサイドバーを開きます。
2.  **LCC Tools** タブをクリックします。
3.  **Import LCC (.lcc)** ボタンをクリックします。
4.  対象の `.lcc` ファイルを選択します。
5.  インポート設定を調整します：
    *   **Min LOD / Max LOD**: 読み込むLODレベルの範囲を指定します。
    *   **Scale Multiplier**: スプラットのサイズ倍率（デフォルト: 1.5）。
    *   **Min Thickness**: スプラットの最小厚み。
    *   **LOD Distance**: 距離による表示密度減衰の強さを調整します。
    *   **Setup 360 Render**: レンダリング設定の自動セットアップを行います。
6.  **Import LCC** をクリックして完了します。

## インポート設定の詳細

*   **Min LOD / Max LOD**:
    *   インポートするLODレベルの開始と終了を指定します。範囲内の全てのLODデータが読み込まれ、一つのメッシュに統合されます。
*   **Scale Multiplier**:
    *   全てのスプラットのスケールを乗算します。値を大きくすると隙間が埋まりますが、形状が肥大化して見える場合があります。
*   **Min Thickness**:
    *   スプラットの最小軸に対して最小スケールを強制します。薄いスプラットが角度によって消えてしまうのを防ぎます。
*   **Render Distance** (LOD Distance):
    *   カメラからの距離に応じた点の間引き（カリング）計算に使用される係数です。
    *   値が大きいほど、遠くの点が表示されやすくなります。値が小さいと、カメラから離れた点がより早く非表示になります。
*   **Setup 360 Render**:
    *   レンダリングエンジンを **Cycles** に切り替えます。
    *   (0,0,0) の位置に **PanoramaCam** を作成します。
    *   解像度を 4096x2048 に設定します。
    *   **透過バウンス数**：Max Bouncesを32、Transparent Max Bouncesを64に設定し、多数の半透明スプラットが重なるシーンでの黒ずみを防ぎます。

### 3DGS関連の設定

*   **Use GLSL Viewport**:
    *   OpenGLベースの高性能GLSLレンダラーを有効化します（デフォルト: オン）。
    *   無効にすると、ジオメトリノードベースのフォールバックレンダラーが使用されます。
    *   GLSLレンダラーは、大量のスプラットをリアルタイムで描画する際に大幅なパフォーマンス向上を提供します。
*   **Viewport Density (%)**:
    *   ビューポートで表示するスプラットの割合（0.1〜100%、デフォルト: 10%）。
    *   値を下げるとビューポートのパフォーマンスが向上しますが、表示の精度は低下します。
    *   レンダリング時は常に100%のデータが使用されます。
    *   注：最小値は0.1%で、0に設定することはできません。
*   **Chunk Grid Size**:
    *   空間分割に使用するグリッドセルのサイズ（デフォルト: 10.0）。
    *   レンダリング時にシーンを複数のチャンクに分割し、効率的な管理とカリングを可能にします。
*   **Chunk Culling Distance**:
    *   この距離より遠いチャンクはレンダリングから除外されます（デフォルト: 0 = 無効）。
    *   大規模シーンでレンダリングパフォーマンスを向上させるために使用します。

## 技術的詳細

*   **データ構造**: `Index.bin` と `Data.bin` から位置、色、スケール、回転、LODレベルを読み込みます。
*   **回転**: パックされた uint32 形式からクォータニオンへ、さらにオイラー角へと変換されます。
*   **ビューポート表示**: `GeometryNodeIsViewport` ノードを使用し、プレビュー時はランダムに点を間引くことで操作性を向上させています。
*   **レンダリング**: ポイント上にCubeをインスタンス化し、シェーダーでガウス分布のアルファマスクを適用することで、滑らかなスプラットとして描画します。

## 3DGS (3D Gaussian Splatting) 表現技術

このツールは、最新の3Dガウススプラッティング技術を実装しています（`LCC_Render.py` と `LCC_GLSL_Renderer.py`）。

### GLSLレンダリングシステム

*   **高性能OpenGLレンダラー**: ビューポートでリアルタイムに大量のガウススプラットを描画
*   **テクスチャベースのインスタンシング**: 位置、色、スケール、回転データをGPUテクスチャに格納し、効率的にアクセス
*   **適応的なビューポート密度**: パフォーマンスを最適化するための調整可能なサンプリングレート（デフォルト10%）
*   **動的ソーティング**: カメラ移動に応じた深度ソート（距離閾値により最適化）

### 共分散行列とEWAスプラッティング

*   **3D共分散行列計算**: 回転（クォータニオン）とスケールから3D共分散行列を構築
*   **カメラ空間への変換**: ビュー行列を使用して共分散行列をカメラ空間に変換
*   **2D投影**: ヤコビアン行列を使用した透視投影により、3D楕円体を2D楕円に変換
*   **固有値分解**: 楕円の主軸と半径を計算し、正確な形状を決定
*   **ガウス減衰**: 3σルール（99%カバレッジ）を適用した正確なガウス分布

### インスタンシング最適化

*   **GPU駆動レンダリング**: 全スプラットデータをGPUメモリに配置
*   **シングルドローコール**: 1回の描画命令で数百万のスプラットをレンダリング
*   **クアッドベースジオメトリ**: 各スプラットを最小限の2三角形クアッドとして描画
*   **視錐台カリング**: カメラ背後のスプラットを自動的に除外
*   **空間分割**: チャンクベースのカリングによる大規模シーンの最適化

### シェーダーの技術的詳細

**頂点シェーダー**:
*   クォータニオンから回転行列への変換
*   スケール行列との結合による変換行列の構築
*   3D共分散行列の計算 (V = M × M^T)
*   透視投影のヤコビアン行列の計算
*   2D画面空間における共分散行列の導出
*   楕円の固有値分解と主軸の計算
*   適応的なクアッド頂点の配置

**フラグメントシェーダー**:
*   半径ベースのガウス減衰計算 (α = exp(-0.5 × r² / σ²)、ここでσは標準偏差で3σ=1として正規化)
*   アルファブレンディングの最適化
*   早期ディスカードによるフラグメントの削減

### 使用オプション

**インポート時の設定**:
*   **Use GLSL Viewport**: GLSLレンダラーを有効化（デフォルト: オン）
*   **Viewport Density (%)**: ビューポートで使用するスプラットの割合（0.1〜100%）
*   **Chunk Grid Size**: 空間分割のグリッドサイズ
*   **Chunk Culling Distance**: チャンクをカリングする距離（0 = 無効）

GLSLレンダラーが無効または利用できない場合、システムはジオメトリノードベースのフォールバックレンダラーに切り替わります。
